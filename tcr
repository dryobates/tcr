#! /bin/sh
# https://github.com/dryobates/tcr

set -euo pipefail

main() {
    expected=${1:-}
    case $expected in
        red)
            check_guards
            test && revert || commit "T"
            ;;
        green)
            check_guards
            set_behaviour_or_structure_prefix
            test && commit $prefix || revert
            ;;
        *)
            error "Usage: tcr {red,green} [msg]"
            ;;
    esac
}

check_guards() {
    error_when_not_git_repository
    error_when_no_initial_commit
}

error_when_not_git_repository() {
    [ -d .git ] || error "Run from git repository!"
}

error_when_no_initial_commit() {
    git show > /dev/null 2>&1 || error "At least initial commit is needed"
}

error() {
    echo $1
    exit 1
}

test() {
    $TCR_TEST_COMMAND
}

set_behaviour_or_structure_prefix() {
    last_prefix_is_B_or_S=`git show -s --format='format:%s' | grep -o '^[BS]' || true`
    if [ -z $last_prefix_is_B_or_S ];
    then
        prefix="B"
    else
        prefix="S"
    fi
}


commit() {
    prefix=${1:-}
    git commit -am "$prefix working"
}

revert() {
    git stash
    exit 1
}

main $*
